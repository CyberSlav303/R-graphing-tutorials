---
title: "Creating density plots in R using ggplot2"
author: 
  - Jodie Burchell
  - Mauricio Vargas Sepúlveda 帕夏
date: "`r Sys.Date()`"
output: 
      rmarkdown::html_vignette:
        css: css/entries.css
---

```{r setup, cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE, tidy = FALSE}
knitr::opts_chunk$set(message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 100, fig.width=6, fig.height=5, tidy = F, cache.path = '.cache/', fig.path = 'Histograms/')
```

In this tutorial we will demonstrate some of the many options the `ggplot2` package has for creating and customising density plots. We will use R's [airquality dataset](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/airquality.html) in the `datasets` package.

The first thing to do is load in the data, as below:

```{r load_in_data}
rm(list = ls())
library(datasets)
library(ggplot2)

data(airquality)
```

In this tutorial, we will work towards creating the histogram below. We will take you from a basic histogram and explain all the customisations we add to the code step-by-step.

```{r final_graph, echo = FALSE}
library(RColorBrewer)

airquality_trimmed <- airquality[which(airquality$Month == 5 |
                                       airquality$Month == 6 |
                                       airquality$Month == 7), ]
airquality_trimmed$Month.f <- factor(airquality_trimmed$Month, 
                                     labels = c("May", "June", "July"))

ggplot(airquality_trimmed, aes(x = Ozone, colour = Month.f)) + 
    geom_density(position="identity", fill = NA, size = 1) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Frequency histogram of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma"),
           legend.position = "bottom") +
    scale_colour_brewer(palette="Accent") +
    labs(fill="Month")
```

## Basic density plot

In order to initialise a plot we tell ggplot that `airquality` is our data, and specify that our x axis plots the `Ozone` variable. We then instruct ggplot to render this as a density plot by adding the `geom_density()` option.

```{r basic_plot}
ggplot(airquality, aes(x = Ozone)) + 
                geom_density()
```

## Customising axis labels

### Single line labels

In order to change the axis labels, we have a couple of options. In this case, we have used the `scale_x_continuous` and `scale_y_continuous` options, as these have further customisation options for the axes we will use below. In each, we add the desired name to the `name` argument as a string.

```{r changing_axis_labels_1}
ggplot(airquality, aes(x = Ozone)) + 
    geom_density() +
    scale_x_continuous(name = "Mean ozone in parts per billion") +
    scale_y_continuous(name = "Count")
```

### Multiline labels

ggplot also allows for the use of multiline names (in both axes and titles). Here, we've changed the x-axis label so that it goes over two lines using the `\n` character to break the line.

```{r changing_axis_labels_2}
ggplot(airquality, aes(x = Ozone)) + 
    geom_density() +
    scale_x_continuous(name = "Mean ozone in\nparts per billion") +
    scale_y_continuous(name = "Count")
```

## Changing axis ticks

The next thing we will change is the axis ticks. Let's make the x-axis ticks appear at every 25 units rather than 50 using the `breaks = seq(0, 200, 25)` argument in `scale_x_continuous`. (The `seq` function is a base R function that indicates the start and endpoints and the units to increment by respectively. See `help(seq)` for more information.) We ensure that the x-axis begins and ends where we want by also adding the argument `limits = c(0, 200)` to `scale_x_continuous`.

```{r changing_ticks}
ggplot(airquality, aes(x = Ozone)) + 
    geom_density() +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count")
``` 

## Adding a title

To add a title, we include the option `ggtitle` and include the name of the graph as a string argument.

```{r adding_title}
ggplot(airquality, aes(x = Ozone)) + 
    geom_density() +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone")
```

## Changing the colour of the curves

### By colour name

To change the line and fill colours of the bars, we add a valid colour to the `colour` and `fill` arguments in `geom_density()` (note that I assigned these colours to variables outside of the plot to make it easier to change them). A list of valid colours is [here](http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf).

```{r changing_fill_1}
fill <- "gold1"
line <- "goldenrod2"

ggplot(airquality, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone")
```

### By HEX code

If you want to go beyond the options in the list above, you can also specify exact HEX colours by including them as a string preceded by a hash, e.g., "#FFFFFF". Below, we have called two shades of blue for the fill and lines using their HEX codes.

```{r changing_fill_2}
fill <- "#4271AE"
line <- "#1F3552"

ggplot(airquality, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone")
```

### Colour transparency

You can also specify the degree of transparency in the density fill area using the argument `alpha` in `geom_density`. This ranges from 0 to 1.

```{r transparency}
ggplot(airquality, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line,
                 alpha = 0.6) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone")
```

## Overall customisation using themes

In order to change elements such as the font type and size, background colour, legend position, axis width and more, we need to use themes. 

### Using ggplot2 themes

One way to use themes is to apply those that other people have built. Below we use the 'white' theme that comes with `ggplot2` by adding the option `theme_bw()` to our graph. You can see it changes the background to white and adds a border to the graph area.

```{r themes_white}
ggplot(airquality, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line,
                 alpha = 0.6) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone") +
    theme_bw()
```

### Using ggthemes

There are a wider range of pre-built themes available as part of the `ggthemes` package (more information on these [here](https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html)). Below I've applied `theme_economist()`, which approximates graphs in the Economist magazine.

```{r theme_economist}
library(ggthemes)

ggplot(airquality, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line,
                 alpha = 0.6) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone") +
    theme_economist()
```

### Making your own theme

Of course, you may want to create your own themes as well. ggplots allows for a very high degree of customisation, including allowing you to use imported fonts. Below is an example of a theme Mauricio was able to create which mimics the visual style of [XKCD](http://xkcd.com/). In order to create this chart, you first need to import the xkcd font, install it on your machine and load it into R using the `extrafont` package.
These instructions are taken from [here](https://www.google.com.au/url?sa=t&rct=j&q=&esrc=s&source=web&cd=1&ved=0ahUKEwiWzafchdPJAhVBpJQKHe_LDT8QFggbMAA&url=https%3A%2F%2Fcran.r-project.org%2Fweb%2Fpackages%2Fxkcd%2Fvignettes%2Fxkcd-intro.pdf&usg=AFQjCNE-KciGY14e-Q1buYIVmTFC0ht__Q&sig2=DZUwkvIHwfNWtTtkcz94jg):

```{r importing_font_xkcd, eval = FALSE}
library(extrafont)

download.file("http://simonsoftware.se/other/xkcd.ttf", 
              dest="xkcd.ttf", mode="wb")
system("mkdir ~/.fonts")
system("cp xkcd.ttf  ~/.fonts")
font_import(paths = "~/.fonts", pattern="[X/x]kcd")
fonts()
loadfonts()
```

Now that the font is loaded, you now need to customise the theme options. You can see this has been done outside the graph in a variable called `theme_xkcd`, however, you could do this as a `theme` option inside the plot as well. In this case, the graph background and grids have been made white, the axis lines have been thickened, and the font for both the title and the axes has been changed to the imported xkcd font. I have also changed the density line to black and the fill to white. Finally, I thickened the density line using the `size` argument in the `geom_density` option.

```{r own_theme}
theme_xkcd <- theme(
    axis.line = element_line(size=1, colour = "black"), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank(),
    plot.title=element_text(size = 20, family="xkcd-Regular"), 
    text=element_text(size = 16, family="xkcd-Regular"), 
    axis.text.x=element_text(colour="black", size = 12), 
    axis.text.y=element_text(colour="black", size = 12)
) 

fill <- "white"
line <- "black"

ggplot(airquality, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line,
                 size = 1) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone") +
    theme_xkcd
```

## Adding lines

Let's go back to our white themed graph going forward, but let's change the font to Tahoma. As you can see, we did this by changing the theme back to `theme_bw()`, and then adding a `theme` option. To change the font of the title, we've added the `plot.title = element_text(size = 14, family = "Tahoma", face = "bold")` arguments to `theme`, which tells R to change the plot title to Tahoma, size 14 and bold. Similarly, to change the plot font, we added the `text = element_text(size = 12, family = "Tahoma")` argument to `theme`, which tells R to change the axis fonts to Tahoma, size 12.

Let's say that we want to add a cutoff value to the chart (75 parts of ozone per billion). We add the `geom_vline` option to the chart, and specify where it goes on the x-axis using the `xintercept` argument. We can customise how it looks using the `colour` and `linetype` arguments in `geom_vline`. (In the the same way, horizontal lines can be added using the `geom_hline`.)

```{r lines}
fill <- "#4271AE"
line <- "#1F3552"

ggplot(airquality, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line,
                 alpha = 0.6) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma")) +
    geom_vline(xintercept = 75, size = 1, colour = "#FF3721", 
               linetype = "dashed")
```

## Multiple densities

You can also easily create multiple density plots by the levels of another variable. There are two options, in separate (panel) plots, or in the same plot. There are also a couple of variations on these we'll discuss below.

### In panel plots

We first need to do a little data wrangling. In order to make the graphs a bit clearer, we've kept only months "5" (May), "6" (June) and "7" (July) in a new dataset `airquality_trimmed`. We also need to convert this variable into either a character or factor variable. We have created a new factor variable `Month.f`.

In order to produce a panel plot by month, we add the `facet_grid(. ~ Month.f)` option to the plot.

```{r multiple_histograms_panels}
airquality_trimmed <- airquality[which(airquality$Month == 5 |
                                       airquality$Month == 6 |
                                       airquality$Month == 7), ]
airquality_trimmed$Month.f <- factor(airquality_trimmed$Month, 
                                     labels = c("May", "June", "July"))

ggplot(airquality_trimmed, aes(x = Ozone)) + 
    geom_density(fill = fill, colour = line,
                 alpha = 0.6) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma")) +
    facet_grid(. ~ Month.f)
```

### Volcano plots

An alternative to a panel plot is the volcano plot. This plot swaps the axes (so the variable of interest is on the y-axis and the density is on the x-axis), and reflects the density. In order to create this plot, we replace `geom_density` with `stat_density`, and include the arguments `aes(ymax = ..density..,  ymin = -..density..)` and `geom = "ribbon"` to create a density plot, the usual `fill`, `colour` and `alpha` arguments, and `position = "identity"`. We also need to add a `coord_flip()` option to the plot.

```{r multiple_histograms_volcano}
ggplot(airquality_trimmed, aes(x = Ozone)) + 
    stat_density(aes(ymax = ..density..,  ymin = -..density..),
                 geom = "ribbon", 
                 fill = fill, colour = line, alpha = 0.6,
                 position = "identity") +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Density plot of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma")) +
    facet_grid(. ~ Month.f) +
    coord_flip()
```

### In the same plot

In order to plot the three months in the same plot, we add several things. Firstly, in the `ggplot` function, we add a `fill = Month.f` argument to `aes`. Secondly, in order to more clearly see the graph, we add the argument `position = "identity"` to the `geom_density` option. This controls the position of the curves respectively. Finally, you can customise the colours of the histograms by adding the `scale_fill_brewer` to the plot from the `RColorBrewer` package. [This](http://moderndata.plot.ly/create-colorful-graphs-in-r-with-rcolorbrewer-and-plotly/) blog post describes the available packages.

```{r multiple_histograms_same_plot}
library(RColorBrewer)

ggplot(airquality_trimmed, aes(x = Ozone, fill = Month.f)) + 
    geom_density(position="identity", alpha=0.6) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Frequency histogram of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma")) +
    scale_fill_brewer(palette="Accent")
```

### Stacked densities

These densities are a little hard to see. One way we can make it easier to see them is to stack the densities on top of each other. To do so, we swap `position = "stack"` for `position = "identity"` in `geom_density`.

```{r multiple_histograms_stacked}
ggplot(airquality_trimmed, aes(x = Ozone, fill = Month.f)) + 
    geom_density(position = "stack", alpha = 0.6) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Frequency histogram of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma")) +
    scale_fill_brewer(palette="Accent")
```

### Just the lines

Another way to make it a little easier to see the densities by dropping out the fill. To do this need a few changes. We need to swap the option `fill = Month.f` in `ggplot` for `colour = Month.f`. We add the `fill = NA` to `geom_density`, and we've also added `size = 1` to make it easier to see the lines. Finally, we change the `scale_fill_brewer()` option for `scale_colour_brewer()`.

```{r multiple_histograms_lines_only}
ggplot(airquality_trimmed, aes(x = Ozone, colour = Month.f)) + 
    geom_density(position="identity", fill = NA, size = 1) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Frequency histogram of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma")) +
    scale_colour_brewer(palette="Accent")
```

## Formatting the legend

Finally, we can format the legend. Firstly, we can change the position by adding the `legend.position = "bottom"` argument to the `theme` option, which moves the legend under the plot. Secondly, we can fix the title by adding the `labs(fill="Month")` option to the plot.

```{r legend_formatting}
ggplot(airquality_trimmed, aes(x = Ozone, colour = Month.f)) + 
    geom_density(position="identity", fill = NA, size = 1) +
    scale_x_continuous(name = "Mean ozone in\nparts per billion",
                              breaks = seq(0, 200, 25),
                              limits=c(0, 200)) +
    scale_y_continuous(name = "Count") +
    ggtitle("Frequency histogram of mean ozone") +
    theme_bw() +
    theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"), 
                text = element_text(size = 12, family = "Tahoma"),
           legend.position = "bottom") +
    scale_colour_brewer(palette="Accent") +
    labs(fill="Month")
```


